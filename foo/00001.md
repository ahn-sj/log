---
title: DDL을 코드로 형상 관리 하는 것에 대한 생각
tags: ["database", "migration", "ddl"]
categories: ["database", "operation"]
---

이전 회사에서는 데이터베이스 기반의 로직이 상당히 많았다. 다행히도 이전 DBA분이 테이블, 프로시저를 형상관리 하는 솔루션이 존재했다.

> 올해초에 단위테스트 관련 책으로 스터디하는 과정에서 'p335, 상태 기반 데이터베이스 / 마이그레이션 기반 데이터베이스 ...'로 정리한 내용도 있다.<br/>
> 이때, 회사에 구현되어 있던 형상관리 툴은 여기서 말하는 상태 기반, 마이그레이션 기반을 모두 만족하고 있었다.

물론, 해당 형상관리를 구축하는데 필요한 사전 준비와 그 과정을 본다면 무조건 좋다라고 볼 수 없었지만 다른 방법으로 뭐가 있냐라고 한다면 스프링에서는 [Flyway](https://github.com/flyway/flyway)와 관련된 레퍼런스를 무수히 많이 봤다.

그리고 이번에 이직하게 될 회사의 기술 스택인 장고를 공부하다보니 자체적으로 [migration](https://docs.djangoproject.com/en/5.2/topics/migrations/)을 제공하고 있었다. 실제로 이 기능을 적극적으로 사용하고 있는지는 모르겠지만 형상관리에 대한 고민이 다시 또 들게 되었다.

우선 결론적으로만 본다면 형상 관리하는 것에는 단점보다 장점이 많다는 점에는 동의하지만 **실제 운영에 적용하는 것에 있어서는 반신반의**하다.

이유는 크게 2가지가 있다.

1. DDL문의 오류로 서비스 가용성에 영향을 줄 수 있다.

작성한 DDL문이 잘못 작성되었다면 서버가 뜨는 것에 방해한다는 걸 느꼈다. 보통 개발, 스테이지, 운영 환경으로 나뉘어 운영된다는 점을 생각한다면 운영까지 직접적으로 영향을 받는 상황을 그리 많다고 판단되지만 이러한 문제도 없다라고 볼 수 없다.

또한, 만약 이를 알게 되더라도 만약, DDL은 잘 반영이 되었지만 애플리케이션이 바라보고 있는 곳이 잘못되거나 한다면 핫픽스로 직접 DB에 DDL을 때려넣거나 형상관리하는 파일을 수정하여 다시 배포를 해야할 것이다.<br/>

만약, 대규모 데이터가 담긴 테이블에 인덱스를 상황도 본다면 이때에는 서버 변경 사항 반영 + 테이블 락이 한 번에 이루어져 응답 지연이나 타임아웃이 발생하는 문제가 발생할 수도 있다.

2. 롤링 배포를 할 때 복잡도가 매우 증가한다.

이전 회사에서는 무중단 배포 전략으로 롤링 방식을 사용했는데 만약, A,B 두 대의 서버가 띄워진 상태라면 롤링 배포중에 DB 스키마가 적용된 A는 정상 동작하지만, B는 구버전 서버를 이용하기 때문에 이를 호환하기 위한 하위 호환성을 맞추는 공수가 꽤나 클 것 같다는 생각이다.

상황적으로 본다면 컬럼 추가/삭제, NOT NULL 제약 추가가 있을 것 같다.

롤백을 해야하는 상황에도 이에 대한 배포 시간동안의 데이터 정합성도 또 고려가 되어야 한다.

--- 

### Action Item

1. 백엔드 개발을 위한 핸즈온 장고의 p155 내용에 이러한 내용이 있다.

- --fake 옵션을 사용해야 하는 상황 예시에 "PostgreSQL에는 DDL 수행시 하나라도 실패하면 데이터베이스가 알아서 롤백해주는 기능이 존재 ...", "PostgreSQL은 DDL 수행 시 마이그레이션 파일 단위로 트랜잭션을 보장한다."의 내용이 있었다.
- 그동안 MySQL에 대해서만 알고있었는데 이직할 회사에는 PostgreSQL을 사용하고 있어서 보던 책 다 보고 애플리케이션 개발이 익숙해질때면 PostgreSQL도 조금 더 공부해봐야겠다.
